name: Backend CD

on:
  push:
    branches: [main]
    paths: ['backend/**']

env:
  ACR_NAME: smartdocsacr          # Azure Container Registry
  IMAGE_NAME: smartdocs-backend
  RESOURCE_GROUP: rg-smartdocs
  CONTAINER_APP: smartdocs-api    # Azure Container App name

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login no Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login no ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build e Push imagem
        run: |
          cd backend
          IMAGE_TAG=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          IMAGE_LATEST=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST

      - name: Deploy no Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Rodar migrations (alembic upgrade head)
        run: |
          set -euo pipefail
          URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          for i in 1 2 3 4 5; do
            curl -fsS "https://$URL/health" && break || sleep 3
          done
          REVISION=$(az containerapp show \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.latestRevisionName" -o tsv)
          az containerapp exec \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision "$REVISION" \
            --command "sh -lc 'cd /app && alembic upgrade head'"

      - name: Verificar deploy
        run: |
          URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "App URL: https://$URL"
          curl -f "https://$URL/docs" || echo "⚠️ Health check falhou"
